---

- name: "MEDIUM | RHEL-07-010019 | PATCH | RHEL 7 must ensure cryptographic verification of vendor software packages."
  block:
      - name: "MEDIUM | RHEL-07-010019 | PATCH | RHEL 7 must ensure cryptographic verification of vendor software packages. | package installed"
        ansible.builtin.package:
            name: "{{ gpg_package }}"
            state: present
        when: "gpg_package not in ansible_facts.packages"

      - name: "MEDIUM | RHEL-07-010019 | AUDIT | RHEL 7 must ensure cryptographic verification of vendor software packages. | Confirm keys"
        ansible.builtin.shell: "gpg -q --keyid-format short --with-fingerprint {{ rpm_gpg_key }} | grep -A1 '{{ item.name }}' | grep '{{ item.fingerprint }}'"
        changed_when: false
        failed_when: rhel_07_010019_gpg_info.rc not in [ 0, 1]
        register: rhel_07_010019_gpg_info
        loop: "{{ gpg_keys }}"
        loop_control:
            label: item.name

      - name: "MEDIUM | RHEL-07-010019 | AUDIT | RHEL 7 must ensure cryptographic verification of vendor software packages. | warn"
        ansible.builtin.debug:
            msg:
                - "WARNING!! Please investigate the vendor gpgkeys match expected values"
        loop: "{{ rhel_07_010019_gpg_info.results }}"
        when: item.rc != 0
  tags:
      - RHEL-07-010019

- name: "MEDIUM | RHEL-07-010050 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  ansible.builtin.copy:
      content: "{{ rhel7stig_logon_banner_nice }}"
      dest: "{{ item }}"
      owner: root
      group: root
      mode: 0644
  with_items:
      - /etc/issue
      - /etc/issue.net
  tags:
      - RHEL-07-010050
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-010090 | PATCH | The Red Hat Enterprise Linux operating system must have the screen package installed."
  ansible.builtin.package:
      name: screen
      state: present
  when:
      - "'screen' not in ansible_facts.packages"
      - "'tmux' not in ansible_facts.packages"
  tags:
      - RHEL-07-010090
      - screen

- name: "MEDIUM | RHEL-07-010118 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that /etc/pam.d/passwd implements /etc/pam.d/system-auth when changing passwords."
  ansible.builtin.lineinfile:
      path: /etc/pam.d/passwd
      regexp: '^password\s+substack\s+system-auth'
      line: 'password   substack     system-auth'
  tags:
      - RHEL-07-010118
      - pamd

- name: "MEDIUM | RHEL-07-010119 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/pam.d/system-auth
      regexp: '^#?password\s+(required|requisite) pam_pwquality.so retry'
      line: password requisite pam_pwquality.so retry=3
      mode: 0644
  tags:
      - RHEL-07-010119
      - pamd

- name: "MEDIUM | RHEL-07-010120 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ucredit'
      line: "ucredit = -1"
      mode: 0644
  tags:
      - RHEL-07-010120
      - pwquality

- name: "MEDIUM | RHEL-07-010130 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*lcredit'
      line: "lcredit = -1"
      mode: 0644
  tags:
      - RHEL-07-010130
      - pwquality

- name: "MEDIUM | RHEL-07-010140 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*dcredit'
      line: "dcredit = -1"
      mode: 0644
  tags:
      - RHEL-07-010140
      - RHELsality

- name: "MEDIUM | RHEL-07-010150 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*ocredit'
      line: "ocredit = -1"
      mode: 0644
  tags:
      - RHEL-07-010150
      - pwquality

- name: "MEDIUM | RHEL-07-010160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*difok'
      line: "difok = 8"
      mode: 0644
  tags:
      - RHEL-07-010160
      - pwquality

- name: "MEDIUM | RHEL-07-010170 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minclass'
      line: "minclass = 4"
      mode: 0644
  tags:
      - RHEL-07-010170
      - pwquality

- name: "MEDIUM | RHEL-07-010180 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxrepeat'
      line: "maxrepeat = 3"
      mode: 0644
  tags:
      - RHEL-07-010180
      - pwquality

- name: "MEDIUM | RHEL-07-010190 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*maxclassrepeat'
      line: "maxclassrepeat = 4"
      mode: 0644
  tags:
      - RHEL-07-010190
      - pwquality

- name: "MEDIUM | RHEL-07-010199 | PATCH |  The Red Hat Enterprise Linux operating system must be configured to prevent overwriting of custom authentication configuration settings by the authconfig utility."
  block:
      - name: "MEDIUM | RHEL-07-010199 | PATCH |  The Red Hat Enterprise Linux operating system must be configured to prevent overwriting of custom authentication configuration settings by the authconfig utility. | local file"
        ansible.builtin.template:
            src: "{{ item }}.j2"
            dest: "/{{ item }}"
            owner: root
            group: root
            mode: 0644
        loop:
            - etc/pam.d/password-auth-local
            - etc/pam.d/system-auth-local

      - name: "MEDIUM | RHEL-07-010199 | PATCH |  The Red Hat Enterprise Linux operating system must be configured to prevent overwriting of custom authentication configuration settings by the authconfig utility. | copy and symlink"
        ansible.builtin.shell: "if [[ -f {{ item }} && ! -L {{ item }} ]]; then cp -p {{ item }} {{ item }}-ac; ln -sf {{ item }}-local {{ item }} && (exit 99); else (exit 98); fi"
        changed_when: rhel_07_010199_changed.rc == 99
        failed_when: rhel_07_010199_changed.rc not in [ 98, 99 ]
        register: rhel_07_010199_changed
        loop:
            - /etc/pam.d/password-auth
            - /etc/pam.d/system-auth
  tags:
      - RHEL-07-010199
      - pamd

- name: "MEDIUM | RHEL-07-010200 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the PAM system service is configured to store only encrypted representations of passwords."
  community.general.pamd:
      name: "{{ item[0] }}"
      state: "{{ item[1].state }}"
      type: password
      control: sufficient
      module_path: pam_unix.so
      module_arguments: "{{ item[1].args }}"
  with_nested:
      - [ 'system-auth', 'password-auth' ]
      -
          - state: args_present
            args:
                - "sha512"
          - state: args_absent
            args:
                - "md5"
                - "bigcrypt"
                - "sha256"
                - "blowfish"
  tags:
      - RHEL-07-010200
      - pamd

- name: "MEDIUM | RHEL-07-010210 | PATCH | The Red Hat Enterprise Linux operating system must be configured to use the shadow file to store only encrypted representations of passwords."
  ansible.builtin.lineinfile:
      path: /etc/login.defs
      regexp: ^#?ENCRYPT_METHOD
      line: "ENCRYPT_METHOD SHA512"
  tags:
      - RHEL-07-010210
      - login

- name: "MEDIUM | RHEL-07-010220 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that user and group account administration utilities are configured to store only encrypted representations of passwords."
  ansible.builtin.lineinfile:
      path: /etc/libuser.conf
      regexp: ^#?crypt_style
      line: crypt_style = sha512
  tags:
      - RHEL-07-010220
      - login

- name: "MEDIUM | RHEL-07-010230 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 24 hours/1 day minimum lifetime."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/login.defs
      regexp: ^#?PASS_MIN_DAYS
      line: "PASS_MIN_DAYS 1"
      mode: 0644
  tags:
      - RHEL-07-010230
      - login

- name: "MEDIUM | RHEL-07-010240 | RHEL-07-010260"
  block:
    - name: Setting host facts using complex arguments
      ansible.builtin.set_fact:
        my_password_hash: "{{ 'Mypa21ssword512!+zeAY2' | password_hash('sha512') }}"

    - name: Output password hash
      ansible.builtin.debug:
        var: my_password_hash

    - name: | 
        MEDIUM | RHEL-07-010240 | PATCH | Passwords must be restricted to a 24 hours/1 day minimum lifetime.
        MEDIUM | RHEL-07-010260 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime.
      ansible.builtin.user:
        name: "{{ item }}"
        password: "{{ my_password_hash }}"
        password_expire_max: 60
        password_expire_min: 1
      with_items: "{{ user_accounts }}"  

    - name: "MEDIUM | RHEL-07-010260 | PATCH | Set 7 day warning to notify user of password expiration."
      ansible.builtin.shell: "chage -W 7 {{ item }}"
      with_items: "{{ user_accounts }}"
  tags: 
    - password
    - RHEL-07-010240
    - RHEL-07-010260

- name: "MEDIUM | RHEL-07-010250 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 60-day maximum lifetime."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/login.defs
      regexp: ^#?PASS_MAX_DAYS
      line: "PASS_MAX_DAYS 60"
      mode: 0644
  tags:
      - RHEL-07-010250
      - login

- name: "MEDIUM | RHEL-07-010280 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that passwords are a minimum of 15 characters in length."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/security/pwquality.conf
      regexp: '^#?\s*minlen'
      line: "minlen = 15"
      mode: 0644
  tags:
      - RHEL-07-010280
      - pwquality

- name: "MEDIUM | RHEL-07-010310 | PATCH | The Red Hat Enterprise Linux operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  ansible.builtin.lineinfile:
      path: /etc/default/useradd
      regexp: ^#?INACTIVE
      line: INACTIVE=35
  tags:
      - RHEL-07-010310
      - accounts

- name: "MEDIUM | RHEL-07-010339 | PATCH | The Red Hat Enterprise Linux operating system must specify the default 'include' directory for the /etc/sudoers file."
  ansible.builtin.lineinfile:
      path: /etc/sudoers
      regex: '^#includedir'
      line: '#includedir /etc/sudoers.d'
      validate: '/usr/sbin/visudo -cf %s'
  tags:
      - RHEL-07-010339
      - sudoers

# - name: "MEDIUM | RHEL-07-010340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
#   ansible.builtin.replace:
#       path: "{{ item }}"
#       regexp: '^([^#].*)NOPASSWD(.*)'
#       replace: '\1PASSWD\2'
#       validate: '/usr/sbin/visudo -cf %s'
#   with_items:
#       - "{{ rhel7stig_sudoers_files.stdout_lines }}"
#   tags:
#       - RHEL-07-010340
#       - sudoers

- name: "MEDIUM | RHEL-07-010341 | PATCH | The Red Hat Enterprise Linux operating system must restrict privilege elevation to authorized personnel."
  block:
      - name: "MEDIUM | RHEL-07-010341 | AUDIT | The Red Hat Enterprise Linux operating system must restrict privilege elevation to authorized personnel. | Get ALL settings"
        ansible.builtin.shell: grep -iws 'ALL' /etc/sudoers /etc/sudoers.d/* | cut -d":" -f1 | uniq | sort
        changed_when: false
        failed_when: false
        register: rhel_07_010341_sudoers_all

      - name: "MEDIUM | RHEL-07-010341 | PATCH | The Red Hat Enterprise Linux operating system must restrict privilege elevation to authorized personnel. | Remove format 1"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'ALL\s+ALL=(ALL)\s+ALL'
            state: absent
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010341_sudoers_all.stdout_lines }}"
        when: rhel_07_010341_sudoers_all.stdout | length > 0

      - name: "MEDIUM | RHEL-07-010341 | PATCH | The Red Hat Enterprise Linux operating system must restrict privilege elevation to authorized personnel. | Remove format 2"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'ALL\s+ALL=(ALL:ALL)\s+ALL'
            state: absent
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010341_sudoers_all.stdout_lines }}"
        when: rhel_07_010341_sudoers_all.stdout | length > 0
  tags:
      - RHEL-07-010341
      - sudo

- name: "MEDIUM | RHEL-07-010342 | PATCH | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo."
  block:
      - name: "MEDIUM | RHEL-07-010342 | AUDIT | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo. | Get privilege escalation"
        ansible.builtin.shell: grep -Eirs '(!rootpw|!targetpw|!runaspw)' /etc/sudoers /etc/sudoers.d/* | grep -v '#' | cut -d":" -f1 | sort --uniq
        changed_when: false
        failed_when: false
        register: rhel_07_010342_priv_escalation

      - name: "MEDIUM | RHEL-07-010342 | PATCH | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo. | Set privilege escalation for no findings"
        ansible.builtin.lineinfile:
            path: /etc/sudoers
            line: "{{ item }}"
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - Defaults !targetpw
            - Defaults !rootpw
            - Defaults !runaspw
        when: rhel_07_010342_priv_escalation.stdout | length == 0

      - name: "MEDIUM | RHEL-07-010342 | PATCH | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo. | Set privilege escalation for targetpw with findings"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'Defaults !targetpw'
            line: 'Defaults !targetpw'
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010342_priv_escalation.stdout_lines }}"
        when:
            - rhel_07_010342_priv_escalation.stdout | length > 0

      - name: "MEDIUM | RHEL-07-010342 | PATCH | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo. | Set privilege escalation for rootpw with findings"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'Defaults !rootpw'
            line: 'Defaults !rootpw'
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010342_priv_escalation.stdout_lines }}"
        when:
            - rhel_07_010342_priv_escalation.stdout | length > 0

      - name: "MEDIUM | RHEL-07-010342 | PATCH | The Red Hat Enterprise Linux operating system must use the invoking user's password for privilege escalation when using sudo. | Set privilege escalation for runaspw with findings"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'Defaults !runaspw'
            line: 'Defaults !runaspw'
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010342_priv_escalation.stdout_lines }}"
        when:
            - rhel_07_010342_priv_escalation.stdout | length > 0
  tags:
      - RHEL-07-010342
      - sudo

- name: "MEDIUM | RHEL-07-010343 | PATCH | The Red Hat Enterprise Linux operating system must require re-authentication when using the sudo command."
  block:
      - name: "MEDIUM | RHEL-07-010343 | PATCH | The Red Hat Enterprise Linux operating system must require re-authentication when using the sudo command. | Get files with timeout set"
        ansible.builtin.shell: grep -irs 'timestamp_timeout' /etc/sudoers /etc/sudoers.d/* | cut -d":" -f1 | uniq | sort
        changed_when: false
        failed_when: false
        register: rhel_07_010343_timeout_files

      - name: "MEDIUM | RHEL-07-010343 | PATCH | The Red Hat Enterprise Linux operating system must require re-authentication when using the sudo command. | Set value if no results"
        ansible.builtin.lineinfile:
            path: /etc/sudoers
            regexp: 'Defaults timestamp_timeout='
            line: "Defaults timestamp_timeout=1"
            validate: '/usr/sbin/visudo -cf %s'
        when: rhel_07_010343_timeout_files.stdout | length == 0

      - name: "MEDIUM | RHEL-07-010343 | PATCH | The Red Hat Enterprise Linux operating system must require re-authentication when using the sudo command. | Set value if has results"
        ansible.builtin.lineinfile:
            path: "{{ item }}"
            regexp: 'Defaults timestamp_timeout='
            line: "Defaults timestamp_timeout=1"
            validate: '/usr/sbin/visudo -cf %s'
        with_items:
            - "{{ rhel_07_010343_timeout_files.stdout_lines }}"
        when: rhel_07_010343_timeout_files.stdout | length > 0
  tags:
      - RHEL-07-010343
      - sudo

- name: "MEDIUM | RHEL-07-010344 | PATCH | The Red Hat Enterprise Linux operating system must not be configured to bypass password requirements for privilege escalation."
  ansible.builtin.lineinfile:
      path: /etc/pam.d/sudo
      regex: 'pam_succeed_if'
      state: absent
  tags:
      - RHEL-07-010344

- name: "MEDIUM | RHEL-07-010350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must re-authenticate for privilege escalation."
  ansible.builtin.replace:
      path: "{{ item }}"
      regexp: '^([^#].*)!authenticate(.*)'
      replace: '\1authenticate\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items: "{{ rhel7stig_sudoers_files.stdout_lines }}"
  tags:
      - RHEL-07-010350
      - sudoers

- name: "MEDIUM | RHEL-07-010430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the delay between logon prompts following a failed console logon attempt is at least four seconds."
  ansible.builtin.lineinfile:
      path: /etc/login.defs
      regexp: ^#?FAIL_DELAY
      line: "FAIL_DELAY 4"
  tags:
      - RHEL-07-010430
      - login

- name: "MEDIUM | RHEL-07-010460 | PATCH | The Red Hat Enterprise Linux operating system must not allow users to override SSH environment variables."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitUserEnvironment"
      line: PermitUserEnvironment no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-010460
      - ssh

- name: "MEDIUM | RHEL-07-010470 | PATCH | The Red Hat Enterprise Linux operating system must not allow a non-certificate trusted host SSH logon to the system."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?HostbasedAuthentication"
      line: HostbasedAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-010470
      - ssh

- name: "MEDIUM | RHEL-07-010481 | The Red Hat Enterprise Linux operating system must require authentication upon booting into single-user and maintenance modes."
  block:
      - name: "MEDIUM | RHEL-07-010481 | PATCH | Check if the packaged rescue.service file was edited directly"
        ansible.builtin.shell: "cat /usr/lib/systemd/system/rescue.service | grep 'ExecStart=.*/usr/sbin/sulogin'"
        changed_when: false
        failed_when: false
        check_mode: false
        register: systemd_rescue_unit_check

      - name: "MEDIUM | RHEL-07-010481 | PATCH | Force reinstall systemd package to replace edited /usr/lib/systemd/system/rescue.service"
        ansible.builtin.shell: yum -y reinstall systemd
        when: systemd_rescue_unit_check.rc == 1
  tags:
      - RHEL-07-010481
      - rescue

- name: |
      "MEDIUM | RHEL-07-010483 | PATCH | Red Hat Enterprise Linux operating systems version 7.2 or newer booted with a BIOS must have a unique name for the grub superusers account when booting into single-user and maintenance modes."
      "MEDIUM | RHEL-07-010492 | PATCH | Red Hat Enterprise Linux operating systems version 7.2 or newer booted with Unified Extensible Firmware Interface (UEFI) must have a unique name for the grub superusers account when booting into single-user mode and maintenance."
  block:
      - name: "MEDIUM | RHEL-07-010483 | PATCH | Red Hat Enterprise Linux operating systems version 7.2 or newer booted with a BIOS must have a unique name for the grub superusers account when booting into single-user and maintenance modes. | Set grub unique name BIOS"
        ansible.builtin.lineinfile:
            path: /etc/grub.d/01_users
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
        notify:
            - confirm grub2 user cfg
            - make grub2 config
        with_items:
            - { regexp: '^\s*set superusers=', line: '    set superusers="{{ rhel7stig_grub_superusers }}"' }
            - { regexp: '^\s*export superusers', line: '    export superusers'}
            - { regexp: '^\s*password_pbkdf2', line: '    password_pbkdf2 {{ rhel7stig_grub_superusers }} \${GRUB2_PASSWORD}' }
        when: rhel7stig_legacy_boot

      - name: "MEDIUM | RHEL-07-010492 | PATCH | Red Hat Enterprise Linux operating systems version 7.2 or newer booted with Unified Extensible Firmware Interface (UEFI) must have a unique name for the grub superusers account when booting into single-user mode and maintenance. | Set grub unique name UEFI"
        ansible.builtin.lineinfile:
            path: "{{ rhel7stig_bootloader_path }}/grub.cfg"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
        notify:
            - confirm grub2 user cfg
            - make grub2 config
        with_items:
            - { regexp: '^\s*set superusers=', line: '    set superusers="{{ rhel7stig_grub_superusers }}"' }
            - { regexp: '^\s*export superusers', line: '    export superusers' }
            - { regexp: '^\s*password_pbkdf2', line: '    password_pbkdf2 {{ rhel7stig_grub_superusers }} \${GRUB2_PASSWORD}' }
        when: not rhel7stig_legacy_boot
  tags:
      - RHEL-07-010483
      - grub
      - bootloader


# ##############################
# #########   20000  ###########
# ##############################

- name: "MEDIUM | RHEL-07-020019 | AUDIT | The Red Hat Enterprise Linux operating system must have a host-based intrusion detection tool installed."
  ansible.builtin.debug:
      msg:
          - "Please install and enable the latest McAfee HIPS package, available from USCYBERCOM."
          - "If the system does not support the McAfee HIPS package, install and enable a supported intrusion detection system application and document its use with the Authorizing Official."
  tags:
      - audit
      - RHEL-07-020019
      - antivirus

# This control should be manually implemented
- name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
  block:
      - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures. | Get SELinux authorized users"
        ansible.builtin.shell: semanage login -l
        changed_when: false
        failed_when: false
        register: rhel_07_020020_sel_auth_users

      - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures. | Show SELinux authorized users"
        ansible.builtin.debug:
            msg:
                - "Warning!! Below is your SELinux user/group list. Please review and make sure all of the following are met:"
                - "1) All administrators are mapped to staff_u or an appropriately tailored confined SELinux user as defined by the organization"
                - "2) All authorized non-administrative users must be mapped to the user_u SELinux user"
                - "{{ rhel_07_020020_sel_auth_users.stdout_lines }}"
        when: rhel_07_020020_sel_auth_users.stdout | length > 0

      - name: "MEDIUM | RHEL-07-020020 | AUDIT | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures. | Warn that semanage is not installed"
        ansible.builtin.debug:
            msg:
                - "Warning!! You do not have semanage installed! Please installed the needed packages"
        when: "'command not found' in rhel_07_020020_sel_auth_users.stderr"
  tags:
      - RHEL-07-020020

- name: "MEDIUM | RHEL-07-020021 | AUDIT | The Red Hat Enterprise Linux operating system must confine SELinux users to roles that conform to least privilege."
  block:
      - name: "MEDIUM | RHEL-07-020021 | AUDIT | The Red Hat Enterprise Linux operating system must confine SELinux users to roles that conform to least privilege. | Get SELinux Role mappings"
        ansible.builtin.shell: semanage user -l
        changed_when: false
        failed_when: false
        register: rhel_07_020021_sel_role_mappings

      - name: "MEDIUM | RHEL-07-020021 | AUDIT | The Red Hat Enterprise Linux operating system must confine SELinux users to roles that conform to least privilege. | Show SELinux Role mappings"
        ansible.builtin.debug:
            msg: 
              - "Warning!! Below are your SELinux Role mappings. Please review the mappings with your SA to determine validity of the mappings"
              - "{{ rhel_07_020021_sel_role_mappings.stdout_lines }}"
        when: rhel_07_020021_sel_role_mappings.stdout | length > 0

      - name: "MEDIUM | RHEL-07-020021 | AUDIT | The Red Hat Enterprise Linux operating system must confine SELinux users to roles that conform to least privilege. | Warning!! that semanage is not installed"
        ansible.builtin.debug:
            msg: "Warning!! You do not have semanage installed! Please installed the needed packages"
        when: "'command not found' in rhel_07_020021_sel_role_mappings.stderr"
  tags:
      - RHEL-07-020021

- name: "MEDIUM | RHEL-07-020022 | PATCH | The Red Hat Enterprise Linux operating system must not allow privileged accounts to utilize SSH."
  ansible.posix.seboolean:
      name: ssh_sysadm_login
      persistent: true
      state: false
  tags:
      - RHEL-07-020022

- name: "MEDIUM | RHEL-07-020023 | AUDIT | The Red Hat Enterprise Linux operating system must elevate the SELinux context when an administrator calls the sudo command"
  block:
      - name: "MEDIUM | RHEL-07-020023 | AUDIT | The Red Hat Enterprise Linux operating system must elevate the SELinux context when an administrator calls the sudo command | Get sysadm_r sudoers status"
        ansible.builtin.shell: grep -rs sysadm_r /etc/sudoers /etc/sudoers.d/*
        changed_when: false
        failed_when: false
        register: rhel_07_020023_sel_admin_sudo_status

      - name: "MEDIUM | RHEL-07-020023 | AUDIT | The Red Hat Enterprise Linux operating system must elevate the SELinux context when an administrator calls the sudo command"
        ansible.builtin.debug:
            msg:
                - "Warning!! Below is your sysadm_r settings in your sudoers file."
                - "Please review to confirm a designated sudoers admin group or account(s) is not configured to eleveate the SELinux type and role to sysadm_t and sysadm_r with the use of the sudo command | Display if entry exists"
                - "{{ rhel_07_020023_sel_admin_sudo_status.stdout_lines }}"
        when: rhel_07_020023_sel_admin_sudo_status.stdout | length > 0

      - name: "MEDIUM | RHEL-07-020023 | AUDIT | The Red Hat Enterprise Linux operating system must elevate the SELinux context when an administrator calls the sudo command"
        ansible.builtin.debug:
            msg:
                - "Warning!! You do not have sysadm_r configured in your sudoers file(s_"
                - "Please configure to designate sudoers administrator group or account(s) is not configured to elevate the SELinux type and role to sysadm_t and sysadm_r with the use of the sudo command | Warning!! that on entry exists"
        when: rhel_07_020023_sel_admin_sudo_status.stdout | length == 0
  tags:
      - RHEL-07-020023

- name: "MEDIUM | RHEL-07-020028 | PATCH | The Red Hat Enterprise Linux operating system must be configured to allow sending email notifications of configuration changes and adverse events to designated personnel."
  ansible.builtin.package:
      name: mailx
      state: present
  when:
      - "'mailx' not in ansible_facts.packages"
  tags:
      - RHEL-07-020028
      - mailx

- name: "MEDIUM | RHEL-07-020029 | PATCH | The Red Hat Enterprise Linux operating system must use a file integrity tool to verify correct operation of all security functions."
  ansible.builtin.package:
      name: aide
      state: present
  notify: "init aide and wait"
  when:
      - "'aide' not in ansible_facts.packages"
  tags:
      - RHEL-07-020029
      - aide

- name: |
    "MEDIUM | RHEL-07-020030 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that a file integrity tool verifies the baseline operating system configuration at least weekly."
    "MEDIUM | RHEL-07-020040 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that designated personnel are notified if baseline configurations are changed in an unauthorized manner."
  ansible.builtin.cron:
      name: 'Run AIDE integrity check daily'
      user: root
      cron_file: aide
      job: "/usr/sbin/aide --check | /bin/mail -s '$(hostname) - Daily AIDE integrity check run' dirk.kappel@effectual.com"
      minute: "0"
      hour: "5"
      day: "*"
      month: "*"
      weekday: "*"
  tags:
      - RHEL-07-020030
      - aide

- name: "MEDIUM | RHEL-07-020100 | PATCH | The Red Hat Enterprise Linux operating system must be configured to disable USB mass storage."
  ansible.builtin.lineinfile:
      path: "{{ item.file }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      insertafter: "{{ item.insertafter }}"
      create: true
      owner: root
      group: root
      mode: "0644"
  with_items:
      - file: /etc/modprobe.d/blacklist.conf
        insertafter: "^#blacklist usb-storage(\\s+|$)"
        regexp: "^install usb-storage(\\s+|$)"
        line: 'blacklist usb-storage'
      - file: /etc/modprobe.d/usb-storage.conf
        insertafter: "^#install usb-storage"
        regexp: "^install usb-storage"
        line: install usb-storage /bin/true
  tags:
      - RHEL-07-020100
      - usb_devices

- name: "MEDIUM | RHEL-07-020101 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the Datagram Congestion Control Protocol (DCCP) kernel module is disabled unless required."
  ansible.builtin.lineinfile:
      path: "{{ item.file }}"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      insertafter: "{{ item.insertafter }}"
      create: true
      owner: root
      group: root
      mode: "0644"
  with_items:
      - file: /etc/modprobe.d/blacklist.conf
        insertafter: ^#blacklist dccp
        regexp: ^blacklist dccp(\s+|$)
        line: blacklist dccp
      - file: /etc/modprobe.d/dccp.conf
        insertafter: ^#install dccp
        regexp: "^install dccp "
        line: install dccp /bin/true
  tags:
      - RHEL-07-020101
      - dccp

- name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  block:
      - name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
        ansible.builtin.shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
        changed_when: false
        check_mode: false
        register: rhel_07_020110_autofs_service_status

      - name: "MEDIUM | RHEL-07-020110 | PATCH | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
        ansible.builtin.service:
            name: autofs
            enabled: false
            state: stopped
        when:
            - rhel_07_020110_autofs_service_status.stdout == "loaded"
  tags:
      - RHEL-07-020110
      - mount

- name: |
    "MEDIUM | RHEL-07-020210 | PATCH | The Red Hat Enterprise Linux operating system must enable SELinux."
    "MEDIUM | RHEL-07-020220 | PATCH | The Red Hat Enterprise Linux operating system must enable SELinux targeted policy."
  ansible.posix.selinux:
      state: enforcing
      policy: targeted
  tags:
      - RHEL-07-020210
      - selinux

- name: "MEDIUM | RHEL-07-020240 | PATCH | The Red Hat Enterprise Linux operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  ansible.builtin.lineinfile:
      path: /etc/login.defs
      regexp: ^#?UMASK
      line: "UMASK 077"
  tags:
      - RHEL-07-020240
      - login
      - umask

- name: "MEDIUM | RHEL-07-020260 | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date."
  ansible.builtin.package:
      name: '*'
      state: latest
  tags:
      - RHEL-07-020260
      - packaging

- name: "MEDIUM | RHEL-07-020270 | AUDIT | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
  block:
      - name: "MEDIUM | RHEL-07-020270 | AUDIT | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
        ansible.builtin.shell: "grep '^{{ item }}:' /etc/passwd"
        failed_when: rhel_07_020270_audit.rc > 1
        changed_when: rhel_07_020270_audit.rc == 0
        register: rhel_07_020270_audit
        with_items:
            - "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | PATCH | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
        ansible.builtin.user:
            name: "{{ item }}"
            state: absent
        register: rhel_07_020270_patch
        with_items:
            - "{{ rhel7stig_unnecessary_accounts }}"

      - name: "MEDIUM | RHEL-07-020270 | AUDIT | Re-parse /etc/passwd since it changed."
        ansible.builtin.include_tasks:
            file: parse_etc_passwd.yml
        vars:
            rhel7stig_passwd_tasks: "RHEL-07-020270"
        when: rhel_07_020270_patch is changed
  tags:
      - RHEL-07-020270
      - accounts

- name: "MEDIUM | RHEL-07-020320 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
  block:
      - name: "MEDIUM | RHEL-07-020320 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
        ansible.builtin.shell: find "{{ item.mount }}" -xdev -nouser
        check_mode: false
        failed_when: false
        changed_when: false
        register: rhel_07_020320_audit
        with_items:
            - "{{ ansible_mounts }}"
        when: item['device'].startswith('/dev') and not 'bind' in item['options']

      - name: "MEDIUM | RHEL-07-020320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
        ansible.builtin.debug:
            msg: "Warning!! Manual intervention is required -- missing owner on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        with_items:
            - "{{ rhel_07_020320_audit.results }}"
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
  tags:
      - RHEL-07-020320

- name: "MEDIUM | RHEL-07-020330 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
  block:
      - name: "MEDIUM | RHEL-07-020330 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
        ansible.builtin.shell: find "{{ item.mount }}" -xdev -nogroup
        check_mode: false
        failed_when: false
        changed_when: false
        register: rhel_07_020330_audit
        with_items:
            - "{{ ansible_mounts }}"
        when: item['device'].startswith('/dev') and not 'bind' in item['options']

      - name: "MEDIUM | RHEL-07-020330 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid group owner."
        ansible.builtin.debug:
            msg: "Warning!! Manual intervention is required -- missing group on items in {{ item.item.mount }}: {{ item.stdout_lines | join(', ') }}"
        with_items:
            - "{{ rhel_07_020330_audit.results }}"
        when:
            - item.stdout_lines is defined
            - item.stdout_lines | length > 0
  tags:
      - RHEL-07-020330

- name: "MEDIUM | RHEL-07-020610 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user accounts, upon creation, are assigned a home directory."
  ansible.builtin.lineinfile:
      path: /etc/login.defs
      regexp: ^#?CREATE_HOME
      line: "CREATE_HOME yes"
  tags:
      - RHEL-07-020610
      - login
      - home

- name: "MEDIUM | RHEL-07-020620 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are defined in the /etc/passwd file."
  ansible.builtin.file:
      path: "{{ item.dir }}"
      state: directory
      mode: 0700
  with_items:
      - "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - item.uid >= rhel7stig_interactive_uid_start | int
  tags:
      - RHEL-07-020620
      - users

- name: "MEDIUM | RHEL-07-020630 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories have mode 0750 or less permissive."
  ansible.builtin.file:
      path: "{{ item.dir }}"
      mode: "g-w,o-rwx"
      state: directory
  with_items:
      - "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel7stig_interactive_uid_start | int <= item.uid
  tags:
      - RHEL-07-020630
      - users

- name: "MEDIUM | RHEL-07-020640 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are owned by their respective users."
  ansible.builtin.file:
      path: "{{ item.dir }}"
      owner: "{{ item.id }}"
      mode: 0700
      state: directory
  with_items:
      - "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel7stig_interactive_uid_start | int <= item.uid
  tags:
      - RHEL-07-020640
      - users

- name: "MEDIUM | RHEL-07-020650 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user home directories are group-owned by the home directory owners primary group."
  ansible.builtin.file:
      path: "{{ item.dir }}"
      group: "{{ item.gid }}"
      state: directory
      mode: 0700
  with_items:
      - "{{ rhel7stig_passwd }}"
  loop_control:
      label: "{{ rhel7stig_passwd_label }}"
  when:
      - rhel7stig_interactive_uid_start |int <= item.uid
  tags:
      - RHEL-07-020650
      - users

- name: "MEDIUM | RHEL-07-020660 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
  block:
      - name: "MEDIUM | RHEL-07-020660 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
        ansible.builtin.shell: "{{ find_command_base }} -print -quit"
        check_mode: false
        changed_when: rhel_07_020660_audit.stdout |length > 0
        register: rhel_07_020660_audit
        with_items: "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: rhel7stig_interactive_uid_start | int <= this_item.uid
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020660 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are owned by the owner of the home directory."
        ansible.builtin.shell: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020660_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
            -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f -o
            -not -user {{ this_item.uid }}'
  tags:
      - RHEL-07-020660
      - users

- name: "MEDIUM | RHEL-07-020670 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
  block:
      - name: "MEDIUM | RHEL-07-020670 | AUDIT | Get all GIDs for each user."
        ansible.builtin.shell: id -G "{{ item.id }}"
        check_mode: false
        changed_when: false
        register: rhel_07_all_gid_audit
        with_items:
            - "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"

      - name: "MEDIUM | RHEL-07-020670 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
        ansible.builtin.shell: "{{ find_command_base }} -print -quit"
        check_mode: false
        changed_when: rhel_07_020670_audit.stdout| length > 0
        register: rhel_07_020670_audit
        with_items:
            - "{{ rhel_07_all_gid_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: this_item.uid >= rhel7stig_int_gid
        vars:
            this_item: "{{ item.item }}"
            this_result: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020670 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories are group-owned by a group of which the home directory owner is a member."
        ansible.builtin.shell: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020670_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: item is changed 
        vars:
            this_item: "{{ item.item.item }}"
            this_result: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*" -type f -o
              -not -group {{ this_result.stdout.split(" ") | join(" -not -group ") }}'
  tags:
      - RHEL-07-020670
      - users

- name: "MEDIUM | RHEL-07-020680 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        ansible.builtin.stat:
            path: "{{ item }}"
        with_items: "{{ rhel7stig_passwd | selectattr('uid', '>=', rhel7stig_interactive_uid_start | int ) | selectattr('uid', '!=', 65534) | map(attribute='dir') | list }}"
        register: rhel_07_020680_audit

      - name: "MEDIUM | RHEL-07-020680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        ansible.builtin.shell: find -H {{ item.0 | quote }} -not -type l -perm /027
        check_mode: false
        changed_when: rhel_07_020680_patch_audit.stdout| length > 0
        register: rhel_07_020680_patch_audit
        with_together:
            - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
            - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
        loop_control:
            label: "{{ item.0 }}"
        when:
             - item.1.exists

      - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        ansible.builtin.file:
            path: "{{ item.0 }}"
            recurse: true
            mode: g-w,o-rwx
        register: rhel_07_020680_patch
        with_together:
            - "{{ rhel_07_020680_audit.results | map(attribute='item') | list }}"
            - "{{ rhel_07_020680_audit.results | map(attribute='stat') | list }}"
        loop_control:
            label: "{{ item.0 }}"
        when:
            - item.1.exists

      # set default ACLs so the homedir has an effective umask of 0027
      - name: "MEDIUM | RHEL-07-020680 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all files and directories contained in local interactive user home directories have a mode of 0750 or less permissive."
        ansible.posix.acl:
            path: "{{ item.0 }}"
            default: true
            state: present
            recursive: true
            etype: "{{ item.1.etype }}"
            permissions: "{{ item.1.mode }}"
        with_nested:
            - "{{ (ansible_check_mode | ternary(rhel_07_020680_patch_audit, rhel_07_020680_patch)).results |
              rejectattr('skipped', 'defined') | map(attribute='item') | map('first') | list }}"
            -
                - etype: group
                  mode: rx
                - etype: other
                  mode: '0'
  tags:
      - RHEL-07-020680
      - permissions

- name: "MEDIUM | RHEL-07-020690 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
  block:
      - name: "MEDIUM | RHEL-07-020690 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
        ansible.builtin.shell: "{{ find_command_base }} -print -quit"
        check_mode: false
        changed_when: rhel_07_020690_audit.stdout | length > 0
        register: rhel_07_020690_audit
        with_items:
            - "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: rhel7stig_interactive_uid_start | int <= this_item.uid
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020690 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for interactive users are owned by the home directory user or root."
        ansible.builtin.shell: "{{ find_command_base }} -exec chown {{ this_item.uid }} {} +"
        with_items: "{{ rhel_07_020690_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not -user {{ this_item.uid }} -o -user root'
  tags:
      - RHEL-07-020690
      - permissions

- name: "MEDIUM | RHEL-07-020700 | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
  block:
      - name: "MEDIUM | RHEL-07-020700 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
        ansible.builtin.shell: "{{ find_command_base }} -print -quit"
        check_mode: false
        changed_when: rhel_07_020700_audit.stdout| length > 0
        register: rhel_07_020700_audit
        with_items:
            - "{{ rhel7stig_passwd }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: rhel7stig_interactive_uid_start | int <= this_item.uid
        vars:
            this_item: "{{ item }}"

      - name: "MEDIUM | RHEL-07-020700 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local initialization files for local interactive users are be group-owned by the users primary group or root."
        ansible.builtin.shell: "{{ find_command_base }} -exec chgrp {{ this_item.gid }} {} +"
        with_items: "{{ rhel_07_020700_audit.results }}"
        loop_control:
            label: "{{ rhel7stig_passwd_label }}"
        when: item is changed
        vars:
            this_item: "{{ item.item }}"
  vars:
      find_command_base: 'find "{{ this_item.dir }}" -mindepth 1 -type f
              -path "{{ this_item.dir }}/.*" -not -path "{{ this_item.dir }}/.*/*"
              -not -group {{ this_item.gid }} -o -group root'
  tags:
      - RHEL-07-020700
      - permissions

- name: "MEDIUM | RHEL-07-020710 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files must have mode 0740 or less permissive."
  ansible.builtin.file:
      path: "{{ item }}"
      mode: '0740'
      state: touch
  with_items:
      - "{{ rhel_07_stig_interactive_homedir_inifiles }}"
  when:
      - rhel_07_stig_interactive_homedir_inifiles is defined
  tags:
      - RHEL-07-020710

- name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
  block:
      - name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
        ansible.builtin.shell: find "{{ item }}" -maxdepth 1 -type f | xargs grep "PATH=" | cut -d':' -f1 | xargs realpath
        with_items: "{{ rhel_07_stig_interactive_homedir_results }}"
        changed_when: false
        failed_when: false
        register: rhel_07_020710_ini_path_grep_list
        when:
            - rhel_07_stig_interactive_homedir_results is defined
            - rhel_07_stig_interactive_homedir_inifiles is defined

      - name: "MEDIUM | RHEL-07-020720 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user initialization files executable search paths contain only paths that resolve to the users home directory."
        ansible.builtin.debug:
            msg: You will need to audit and correct executable paths set in "{{ item }}" to contain only paths that resolve to the user's home directory.
        with_items:
            - "{{ rhel_07_020710_ini_path_grep_list.results | map(attribute='stdout_lines') | list }}"

  tags:
      - RHEL-07-020720

- name: "MEDIUM | RHEL-07-020730 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
  block:
      - name: "MEDIUM | RHEL-07-020730 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
        ansible.builtin.shell: find /home/*/ -xdev -perm -002 -type f -exec ls -ld {} + | awk '{print $9}' | grep '/home/.*/\..*'
        failed_when: false
        changed_when: false
        register: rhel_07_020730_perms_results

      - name: "MEDIUM | RHEL-07-020730 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that local initialization files do not execute world-writable programs."
        ansible.builtin.file:
            path: "{{ item }}"
            mode: '0755'
            state: touch
        with_items:
            - "{{ rhel_07_020730_perms_results.stdout_lines }}"
        when:
            - rhel_07_020730_perms_results.stdout_lines is defined
  tags:
      - RHEL-07-020730

- name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  ansible.builtin.setup:
      gather_subset: selinux,!min,!all
      filter: ansible_selinux
  when:
      - ansible_selinux is not defined
  tags:
      - RHEL-07-020900

- name: "MEDIUM | RHEL-07-020900 | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
  block:
      - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
        ansible.builtin.shell: find {{ rhel7stig_local_mounts | join(' ') }} -xdev -context *:device_t:* -o -context *:unlabeled_t:* -type c -o -type b -printf '%p %Z\n'
        changed_when: false
        check_mode: false
        register: rhel_07_020900_audit

      - name: "MEDIUM | RHEL-07-020900 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all system device files are correctly labeled to prevent unauthorized modification."
        ansible.builtin.debug:
            msg: "{{ rhel_07_020900_audit.stdout_lines }}"
        when: rhel_07_020900_audit.stdout_lines | length > 0
  when:
      - ansible_selinux.status == "enabled"
  tags:
      - RHEL-07-020900

- name: "MEDIUM | RHEL-07-021031 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user."
  block:
      - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Get world-writable files"
        ansible.builtin.shell: "find {{ item.mount }} -xdev -type d -perm -0002 -uid +999 -print"
        changed_when: false
        failed_when: false
        register: rhel_07_021031_world_writable_files
        with_items:
            - "{{ ansible_facts.mounts }}"

      - name: "MEDIUM | RHEL-07-021031 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | Flatten results"
        ansible.builtin.set_fact:
            rhel_07_021031_world_writable_files_flat: "{{ rhel_07_021031_world_writable_files.results | map(attribute='stdout_lines') | flatten }}"

      - name: "MEDIUM | RHEL-07-021031 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that all world-writable directories are owned by root, sys, bin, or an application user. | List world-writable files"
        ansible.builtin.debug:
            msg:
                - "Below are the world-writable files"
                - "{{ rhel_07_021031_world_writable_files_flat }}"
        when:
            - rhel_07_021031_world_writable_files_flat != []
  tags:
      - RHEL-07-021031
      - fileperms
      - permissions

- name: |
      MEDIUM | RHEL-07-021110 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is owned by root.
      MEDIUM | RHEL-07-021120 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is group-owned by root.
  block:
      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Check if cron.allow file exists"
        ansible.builtin.stat:
            path: /etc/cron.allow
        register: cron_allow_file_check

      - name: "MEDIUM | RHEL-07-021110, RHEL-07-021120 | PATCH | Set cron.allow file owner and group-owner to root"
        ansible.builtin.file:
            dest: /etc/cron.allow
            state: file
            owner: root
            group: root
            mode: 0600
        when: cron_allow_file_check.stat.exists
  tags:
      - RHEL-07-021110
      - cron

- name: "MEDIUM | RHEL-07-021300 | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
  block:
      - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
        ansible.builtin.shell: "systemctl show kdump | grep LoadState | cut -d = -f 2"
        register: rhel_07_021300_kdump_service_status
        changed_when: false
        check_mode: false

      - name: "MEDIUM | RHEL-07-021300 | PATCH | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
        ansible.builtin.service:
            name: kdump
            enabled: false
            state: stopped
        when:
            - rhel_07_021300_kdump_service_status.stdout == "loaded"
  tags:
      - RHEL-07-021300
      - logging

- name: "MEDIUM | RHEL-07-021620 | The Red Hat Enterprise Linux operating system must use a file integrity tool that is configured to use FIPS 140-2 approved cryptographic hashes for validating file contents and directories."
  block:
      - name: "MEDIUM | RHEL-07-021620 | Replace sha256+sha512 entries with sha512"
        ansible.builtin.replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256\+sha512)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_512_result

      - name: "MEDIUM | RHEL-07-021620 | Replace sha256 entries with sha512"
        ansible.builtin.replace:
            path: /etc/aide.conf
            regexp: '([A-Z]+ = .*)(sha256)(.*)'
            replace: '\1sha512\3'
        register: rhel_07_021620_sha256_result
  tags:
      - RHEL-07-021620
      - aide

######################
####### 030000 #######
######################

- name: "MEDIUM | RHEL-07-030000 | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
  block:
      - name: "MEDIUM | RHEL-07-030000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
        ansible.builtin.package:
            name: audit
            state: present
        when:
            - "'audit' not in ansible_facts.packages"

      - name: "MEDIUM | RHEL-07-030000 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
        ansible.builtin.service:
            name: auditd
            state: started
            enabled: true
  tags:
      - RHEL-07-030000
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030010 | PATCH | The Red Hat Enterprise Linux operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
  ansible.builtin.lineinfile:
      path: /etc/audit/rules.d/audit.rules
      regexp: "^-f "
      line: "-f 2"
  tags:
      - RHEL-07-030010
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030201 | PATCH | The Red Hat Enterprise Linux operating system must be configured to off-load audit logs onto a different system or storage media from the system being audited."
  ansible.builtin.lineinfile:
      path: /etc/audisp/plugins.d/au-remote.conf
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      create: true
      mode: 0640
  notify: restart auditd
  with_items:
      - { regexp: '^active =', line: 'active = yes'}
      - { regexp: '^direction =', line: 'direction = out' }
      - { regexp: '^path =', line: 'path = /sbin/audisp-remote' }
      - { regexp: '^type =', line: 'type = always' }
      - { regexp: '^format =', line: 'format = string' }
  tags:
      - RHEL-07-030201
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030210 | PATCH | The Red Hat Enterprise Linux operating system must take appropriate action when the remote logging buffer is full."
  ansible.builtin.lineinfile:
      path: /etc/audisp/audispd.conf
      regexp: '^overflow_action ='
      line: "overflow_action = syslog"
  notify: restart auditd
  tags:
      - RHEL-07-030210
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030211 | PATCH | The Red Hat Enterprise Linux operating system must label all off-loaded audit logs before sending them to the central log server."
  ansible.builtin.lineinfile:
      path: /etc/audisp/audispd.conf
      regexp: '^name_format ='
      line: name_format = hostname
  notify: restart auditd
  tags:
      - RHEL-07-030211
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030310 | PATCH | The Red Hat Enterprise Linux operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  ansible.builtin.lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^enable_krb5 +=
      line: enable_krb5 = yes
      create: true
  tags:
      - RHEL-07-030310
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when the audit storage volume is full."
  ansible.builtin.lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^disk_full_action +=
      line: "disk_full_action = syslog"
  tags:
      - RHEL-07-030320
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030321 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when there is an error sending audit records to a remote system."
  ansible.builtin.lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^network_failure_action +=
      line: "network_failure_action = syslog"
  tags:
      - RHEL-07-030321
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030330 | PATCH | The Red Hat Enterprise Linux operating system must initiate an action to notify the System Administrator (SA) and Information System Security Officer ISSO, at a minimum, when allocated audit record storage volume reaches 75% of the repository maximum audit record storage capacity."
  ansible.builtin.lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left +=
      line: "space_left = 25%"
  tags:
      - RHEL-07-030330
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030340 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  ansible.builtin.lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left_action +=
      line: "space_left_action = email"
  failed_when:
      - rhel7stig_auditd_space_left_action_result is failed
      - rhel7stig_auditd_space_left_action_result.rc != 257
  register: rhel7stig_auditd_space_left_action_result
  tags:
      - RHEL-07-030340
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-030350 | PATCH | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  ansible.builtin.lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^action_mail_acct +=
      line: "action_mail_acct = root"
  tags:
      - RHEL-07-030350
      - auditd
      - logging

- name: "MEDIUM | RHEL-07-031010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the rsyslog daemon does not accept log messages from other servers unless the server is being used for log aggregation."
  ansible.builtin.replace:
      path: /etc/rsyslog.conf
      regexp: '({{ item }})'
  with_items:
      - '^(\$ModLoad imtcp)'
      - '^(\$ModLoad imudp)'
      - '^(\$ModLoad imrelp)'
  failed_when:
      - result is failed
      - result.rc != 257
  register: result
  tags:
      - RHEL-07-031010
      - rsyslog

#######################
######## 040000 #######
#######################

- name: "MEDIUM | RHEL-07-040110 | PATCH | The Red Hat Enterprise Linux 7 operating system must implement DoD-approved encryption to protect the confidentiality of SSH connections."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?Ciphers"
      line: "Ciphers aes256-ctr,aes192-ctr,aes128-ctr"
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040110
      - ssh

- name: "MEDIUM | RHEL-07-040160 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with a communication session are terminated at the end of the session or after 15 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  ansible.builtin.lineinfile:
      path: /etc/profile.d/tmout.sh
      regexp: ^TMOUT=
      line: "declare -xr TMOUT=900"
  tags:
      - RHEL-07-040160
      - profile

- name: "MEDIUM | RHEL-07-040170 | PATCH | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner immediately prior to, or as part of, remote access logon prompts."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?Banner"
      line: Banner /etc/issue
      validate: /usr/sbin/sshd -tf %s
  notify: restart sshd
  tags:
      - RHEL-07-040170
      - ssh
      - dod_logon_banner

- name: "MEDIUM | RHEL-07-040201 | PATCH | The Red Hat Enterprise Linux operating system must implement virtual address space randomization."
  ansible.posix.sysctl:
      name: kernel.randomize_va_space
      value: '2'
      state: present
      reload: true
      sysctl_set: true
      ignoreerrors: true
  tags:
      - RHEL-07-040201
      - sysctl

- name: "MEDIUM | RHEL-07-040300 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems have SSH installed."
  ansible.builtin.package:
      name: openssh-server
      state: present
  tags:
      - RHEL-07-040300
      - ssh

- name: "MEDIUM | RHEL-07-040310 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all networked systems use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  ansible.builtin.service:
      name: sshd
      state: started
      enabled: true
  tags:
      - RHEL-07-040310
      - ssh

- name: "MEDIUM | RHEL-07-040320 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic are terminated at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveInterval"
      line: ClientAliveInterval {{ rhel7stig_ssh_session_timeout }}
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040320
      - ssh

- name: "MEDIUM | RHEL-07-040340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic terminate after a period of inactivity."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveCountMax"
      line: ClientAliveCountMax 0
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040340
      - ssh

- name: "MEDIUM | RHEL-07-040350 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using rhosts authentication."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '(?i)^#?\s*IgnoreRhosts'
      line: IgnoreRhosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040350
      - ssh

- name: "MEDIUM | RHEL-07-040360 | PATCH | The Red Hat Enterprise Linux operating system must display the date and time of the last successful account logon upon an SSH logon."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?PrintLastLog"
      line: PrintLastLog yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040360
      - ssh

- name: "MEDIUM | RHEL-07-040370 | PATCH | The Red Hat Enterprise Linux operating system must not permit direct logons to the root account using remote access via SSH."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitRootLogin"
      line: PermitRootLogin no
      insertafter: '(?i)^#?authentication'
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040370
      - ssh

- name: "MEDIUM | RHEL-07-040380 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using known hosts authentication."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreUserKnownHosts"
      line: IgnoreUserKnownHosts yes
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040380
      - ssh

- name: "MEDIUM | RHEL-07-040400 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon is configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?MACs"
      line: "MACs hmac-sha2-512,hmac-sha2-256"
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040400
      - ssh

- name: "MEDIUM | RHEL-07-040410 | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040410 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        ansible.builtin.find:
            paths: /etc/ssh
            recurse: true
            file_type: file
            patterns: 'ssh_host*_key.pub'
            hidden: true
        failed_when: false
        changed_when: false
        register: rhel_07_040410_audit

      - name: "MEDIUM | RHEL-07-040410 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        ansible.builtin.file:
            dest: "{{ item.path }}"
            mode: 0644
            state: file
        with_items: "{{ rhel_07_040410_audit.files | default([]) }}"
  tags:
      - RHEL-07-040410
      - ssh

- name: "MEDIUM | RHEL-07-040420 | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
  block:
      - name: "MEDIUM | RHEL-07-040420 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        ansible.builtin.find:
            paths: /etc/ssh
            recurse: true
            file_type: file
            patterns: 'ssh_host*_key'
            hidden: true
        changed_when: false
        failed_when: false
        register: rhel_07_040420_audit

      - name: "MEDIUM | RHEL-07-040420 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        ansible.builtin.file:
            dest: "{{ item.path }}"
            mode: 06400
            state: file
        with_items:
            - "{{ rhel_07_040420_audit.files | default([]) }}"
  tags:
      - RHEL-07-040420
      - ssh

- name: "MEDIUM | RHEL-07-040430 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?GSSAPIAuthentication"
      line: GSSAPIAuthentication no
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040430
      - ssh

- name: "MEDIUM | RHEL-07-040440 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Kerberos authentication unless needed."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?KerberosAuthentication"
      line: KerberosAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040440
      - ssh

- name: "MEDIUM | RHEL-07-040450 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon performs strict mode checking of home directory configuration files."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?StrictModes"
      line: StrictModes yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040450
      - ssh

- name: "MEDIUM | RHEL-07-040460 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon uses privilege separation."
  ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: "(?i)^#?UsePrivilegeSeparation"
      line: UsePrivilegeSeparation sandbox
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040460
      - ssh

- name: "MEDIUM | RHEL-07-040500 | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  block:
      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        ansible.builtin.package:
            name: ntp
            state: absent
        when: "'ntp' in ansible_facts.packages"

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        ansible.builtin.package:
            name: chrony
            state: present
        when: "'chrony' not in ansible_facts.packages"

      - name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
        ansible.builtin.replace:
            dest: "{{ rhel7stig_time_service_configs.chronyd.conf }}"
            regexp: '^server \S+( \w+)?$'
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040500 | PATCH | The Red Hat Enterprise Linux operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  ansible.builtin.blockinfile:
      insertbefore: BOF
      dest: "{{ rhel7stig_time_service_configs.chronyd.conf }}"
      block: "{{ rhel7stig_time_service_configs.chronyd.block }}"
      state: present
  tags:
      - RHEL-07-040500
      - chronyd

- name: "MEDIUM | RHEL-07-040610 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  ansible.posix.sysctl:
      name: net.ipv4.conf.all.accept_source_route
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040610
      - ipv4

- name: "MEDIUM | RHEL-07-040611 | PATCH | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces."
  ansible.posix.sysctl:
      name: net.ipv4.conf.all.rp_filter
      value: '1'
      state: present
      reload: true
  tags:
      - RHEL-07-040611
      - sysctl
      - ipv4

- name: "MEDIUM | RHEL-07-040612 | PATCH | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible by default."
  ansible.posix.sysctl:
      name: net.ipv4.conf.default.rp_filter
      state: present
      value: '1'
      reload: true
  tags:
      - RHEL-07-040612
      - sysctl
      - ipv4

- name: "MEDIUM | RHEL-07-040620 | PATCH | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  ansible.posix.sysctl:
      name: net.ipv4.conf.default.accept_source_route
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040620
      - ipv4

- name: "MEDIUM | RHEL-07-040630 | PATCH | The Red Hat Enterprise Linux operating system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  ansible.posix.sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      state: present
      value: '1'
      sysctl_set: true
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040630
      - ipv4

- name: "MEDIUM | RHEL-07-040640 | PATCH | The Red Hat Enterprise Linux operating system must prevent Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages from being accepted."
  ansible.posix.sysctl:
      name: net.ipv4.conf.default.accept_redirects
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040640
      - ipv4

- name: "MEDIUM | RHEL-07-040641 | PATCH | The Red Hat Enterprise Linux operating system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages"
  ansible.posix.sysctl:
      name: net.ipv4.conf.all.accept_redirects
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040641
      - ipv4

- name: "MEDIUM | RHEL-07-040650 | PATCH |  The Red Hat Enterprise Linux operating system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  ansible.posix.sysctl:
      name: net.ipv4.conf.default.send_redirects
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040650
      - ipv4

- name: "MEDIUM | RHEL-07-040660 | PATCH | The Red Hat Enterprise Linux operating system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  ansible.posix.sysctl:
      name: net.ipv4.conf.all.send_redirects
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040660
      - ipv4

- name: "MEDIUM | RHEL-07-040670 | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
  block:
      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
        ansible.builtin.shell: "ip link | grep -i promisc | cut -d ':' -f 2"
        changed_when: rhel_07_040670_promisc_check.stdout| length > 0
        failed_when: false
        check_mode: false
        ignore_errors: true
        register: rhel_07_040670_promisc_check

      - name: "MEDIUM | RHEL-07-040670 | PATCH | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
        ansible.builtin.shell: "ip link set dev {{ item }} promisc off"
        with_items:
            - "{{ rhel_07_040670_promisc_check.stdout_lines }}"
  tags:
      - RHEL-07-040670

- name: "MEDIUM | RHEL-07-040680 | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
  block:
      - name: "MEDIUM | RHEL-07-040680 | AUDIT | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
        ansible.builtin.shell: "/usr/sbin/postconf -n smtpd_client_restrictions"
        check_mode: false
        changed_when: false
        register: rhel_07_040680_postconf_audit
        when: "'postfix' in ansible_facts.packages"

      - name: "MEDIUM | RHEL-07-040680 | PATCH | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
        ansible.builtin.shell: "/usr/sbin/postconf -e 'smtpd_client_restrictions=permit_mynetworks, reject'"
        when:
            - "'postfix' in ansible_facts.packages"
            - rhel_07_040680_postconf_audit.stdout != 'smtpd_client_restrictions = permit_mynetworks, reject'
  tags:
      - RHEL-07-040680

- name: "MEDIUM | RHEL-07-040710 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that remote X connections are disabled except to fulfill documented and validated mission requirements"
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?X11Forwarding"
      line: X11Forwarding no
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040710
      - ssh

- name: "MEDIUM | RHEL-07-040712 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that remote X connections are disabled except to fulfill documented and validated mission requirements"
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?KexAlgorithms"
      line: "KexAlgorithms ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256"
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040712
      - ssh

- name: "MEDIUM | RHEL-07-040712 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that remote X connections are disabled except to fulfill documented and validated mission requirements"
  ansible.builtin.lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "HostKey /etc/ssh/ssh_host_ed25519_key"
      line: "#HostKey /etc/ssh/ssh_host_ed25519_key"
  tags:
      - RHEL-07-040712
      - ssh
      
- name: "MEDIUM | RHEL-07-040740 | PATCH | The Red Hat Enterprise Linux operating system must not be performing packet forwarding unless the system is a router."
  ansible.posix.sysctl:
      name: net.ipv4.ip_forward
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040740
      - ipv4

- name: "MEDIUM | RHEL-07-040820 | PATCH | The Red Hat Enterprise Linux operating system must not have unauthorized IP tunnels configured."
  ansible.builtin.package:
      name: libreswan
      state: absent
  when:
      - "'libreswan' not in ansible_facts.packages"
  tags:
      - RHEL-07-040820

- name: "MEDIUM | RHEL-07-040830 | PATCH | The Red Hat Enterprise Linux operating system must not forward IPv6 source-routed packets."
  ansible.posix.sysctl:
      name: net.ipv6.conf.all.accept_source_route
      state: present
      value: '0'
      reload: true
      ignoreerrors: true
  tags:
      - RHEL-07-040830
      - ipv6

- name: "MEDIUM | RHEL-07-041001 | PATCH | The Red Hat Enterprise Linux operating system must have the required packages for multifactor authentication installed."
  ansible.builtin.package:
    name: pam_pkcs11
    state: present
  when: "'pam_pkcs11' not in ansible_facts.packages"
  tags:
      - RHEL-07-041001
      - multifactor

- name: "MEDIUM | RHEL-07-041003 | The Red Hat Enterprise Linux operating system must implement certificate status checking for PKI authentication."
  ansible.builtin.replace:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      regexp: (?im)^([ \t]*cert_policy[ \t]*=(?:[^ \t\n]|[ \t](?!ocsp_on,))*?)(?:[ \t]ocsp_on,[ \t]*)?[ \t]*((?:[^,\n]|,(?![ \t]*ocsp_on,))*?)(?:,[ \t]*ocsp_on)?;$
      replace: '\1 ocsp_on, \2;'
  tags:
      - RHEL-07-041003
      - certificates

- name: "MEDIUM | RHEL-07-041010 | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
  block:
      - name: "MEDIUM | RHEL-07-041010 | AUDIT | check if wifi is enabled"
        ansible.builtin.shell: nmcli radio wifi
        changed_when: false
        check_mode: false
        register: rhel_07_wifi_enabled

      - name: "MEDIUM | RHEL-07-041010 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that all wireless network adapters are disabled."
        ansible.builtin.shell: nmcli radio wifi off
        when:
            - "'enabled' in rhel_07_wifi_enabled.stdout"
  tags:
      - RHEL-07-041010
      - wifi
      - networking

- name: "MEDIUM | RHEL-07-040711 | PATCH | The Red Hat Enterprise Linux operating system must prevent remote hosts from connecting to the proxy display."
  ansible.builtin.lineinfile:
      create: true
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?X11UseLocalhost"
      line: X11UseLocalhost yes
      validate: /usr/sbin/sshd -t -f %s
      mode: 0600
  notify: restart sshd
  tags:
      - RHEL-07-040711
      - ssh

- name: "MEDIUM | RHEL-07-910055 | PATCH | The Red Hat Enterprise Linux operating system must protect audit information from unauthorized read, modification, or deletion"
  block:
      - name: "MEDIUM | RHEL-07-910055 | AUDIT | The Red Hat EnterpriseLinux operating system must protect audit information from unauthorized read, modification, or deletion | Get log files"
        ansible.builtin.find:
            paths: /var/log/audit
        register: rhel_07_910055_audit_log_files

      - name: "MEDIUM | RHEL-07-910055 | PATCH | The Red Hat EnterpriseLinux operating system must protect audit information from unauthorized read, modification, or deletion | Apply permissions"
        ansible.builtin.file:
            path: "{{ item.path }}"
            owner: root
            group: root
            mode: 0600
        with_items:
            - "{{ rhel_07_910055_audit_log_files.files }}"
  tags:
      - RHEL-07-910055
      - logs
