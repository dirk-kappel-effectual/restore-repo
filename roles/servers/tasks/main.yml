---

- name: Install AWS Cloudwatch Agent
  block:
    - name: Download CloudWatch Agent
      ansible.builtin.get_url:
        url: "https://s3.amazonaws.com/amazoncloudwatch-agent/redhat/amd64/latest/amazon-cloudwatch-agent.rpm"
        dest: "/tmp/amazon-cloudwatch-agent.rpm"

    - name: Install CloudWatch Agent
      ansible.builtin.package:
        name: "/tmp/amazon-cloudwatch-agent.rpm"
        state: present
        disable_gpg_check: true

    - name: Copy CloudWatch Agent Configuration file
      ansible.builtin.copy:
        src: "./files/cw_config.json"
        dest: "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json"
        owner: root
        group: root
        mode: 0644
      notify: "Enable CloudWatch Agent"
  tags: cloudwatch

- name: Install Iptables
  ansible.builtin.import_tasks:
    file: firewall.yml
  tags:
    - firewall

- name: "MEDIUM | RHEL-07-010340 | Find all sudoers files."
  ansible.builtin.shell: "find /etc/sudoers /etc/sudoers.d/ -type f ! -name '*~' ! -name '*.*'"
  changed_when: false
  failed_when: false
  check_mode: false
  register: rhel7stig_sudoers_files
  tags:
      - RHEL-07-010340

- name: "Assume Role"
  vars:
    ansible_python_interpreter: /usr/bin/python3
  amazon.aws.sts_assume_role:
    role_arn: "arn:aws:iam::725857994970:role/GitHubAction-AssumeRoleWithAction"
    role_session_name: "GitHub_to_AWS_via_FederatedOIDC"
  register: assumed_role

- name: "View role assumed"
  ansible.builtin.debug:
    var: assumed_role

# - name: "Lookup ec2-user password from parameter store"
#   ansible.builtin.command: /usr/local/bin/aws ssm get-parameter-history --name "/gold_image/ec2-user" --with-decryption --query "Parameters[?contains(Labels, '{{ BASE_AMI }}')].Value | [0]" --output text
#     access_key: "{{ assumed_role.sts_creds.access_key }}"
#     secret_key: "{{ assumed_role.sts_creds.secret_key }}"
#     session_token: "{{ assumed_role.sts_creds.session_token }}"
#   register: ec2_user_password

- name: "Set ec2 user password"
  ansible.builtin.set_fact:
    ansible_become_password: ec2_user_password.stdout  

- name: "MEDIUM | RHEL-07-010340 | PATCH | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
  ansible.builtin.replace:
      path: "{{ item }}"
      regexp: '^([^#].*)NOPASSWD(.*)'
      replace: '\1PASSWD\2'
      validate: '/usr/sbin/visudo -cf %s'
  with_items:
      - "{{ rhel7stig_sudoers_files.stdout_lines }}"
  tags:
    - privilege_escalation

- name: flush handlers
  ansible.builtin.meta: flush_handlers